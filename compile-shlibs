# wasi does not support shared libraries yet :((
# /opt/wasi-sdk/bin/clang -emit-llvm -S otherlibs/str/strstubs.c -o otherlibs/str/strstubs.ll -Iruntime
# /opt/wasi-sdk/bin/clang -o dllcamlstr.wasm -Wl,--allow-undefined -fPIC -Wl,--shared otherlibs/str/strstubs.c -Iruntime

WASI_SDK=${WASI_SDK:=/opt/wasi-sdk}


if [ ! -d ./wasi ]
  then wasi-kit ln -s /tmp/wasi-kit-hijack/include ./wasi
fi

CCSHARED="$WASI_SDK/bin/clang -target wasm32-unknown-emscripten --sysroot $WASI_SDK/share/wasi-sysroot -D__wasi__ -fPIC -Wl,--shared"
CCFLAGS="-Iruntime -include wasi/etc.h"
LDFLAGS="-nostdlib -Wl,--export-all"

#$CCSHARED $CCFLAGS $LDFLAGS otherlibs/str/strstubs.c -o dllcamlstr.wasm
$CCSHARED $CCFLAGS $LDFLAGS wasi-preconf/otherlibs/unixstubs.c -o dllunix.wasm
$CCSHARED $CCFLAGS $LDFLAGS wasi-preconf/otherlibs/st_stubs.c -o dllthreads.wasm

make -C otherlibs/str clean && wasi-kit make -C otherlibs/str
# TODO
# wasi-kit make -C otherlibs/unix
