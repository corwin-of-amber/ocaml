# wasi does not support shared libraries yet :((
# /opt/wasi-sdk/bin/clang -emit-llvm -S otherlibs/str/strstubs.c -o otherlibs/str/strstubs.ll -Iruntime
# /opt/wasi-sdk/bin/clang -o dllcamlstr.wasm -Wl,--allow-undefined -fPIC -Wl,--shared otherlibs/str/strstubs.c -Iruntime

WASI_SDK=/opt/wasi-sdk

if [ ! -d ./wasi ]
  then ln -s /tmp/wasi-kit-hijack/include ./wasi
fi

CCSHARED="$WASI_SDK/bin/clang -target wasm32-unknown-emscripten -D__wasi__ -fPIC -Wl,--shared"
CCFLAGS="-Iruntime -include wasi/etc.h"
LDFLAGS="-nostdlib -Wl,--export-all"

$CCSHARED $CCFLAGS $LDFLAGS wasi-preconf/otherlibs/strstubs.c -o dllcamlstr.wasm
$CCSHARED $CCFLAGS $LDFLAGS wasi-preconf/otherlibs/unixstubs.c -o dllunix.wasm
$CCSHARED $CCFLAGS $LDFLAGS wasi-preconf/otherlibs/st_stubs.c -o dllthreads.wasm
